name: CI

on:
    push:
        branches: [master, main]
    pull_request:
        branches: [master, main]

permissions:
    contents: read

jobs:
    build-test:
        name: Build / Test (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
        defaults:
            run:
                working-directory: ai_runtime
                shell: bash
        env:
            CARGO_TERM_COLOR: always
            # Ensure PyO3 can build against runner Python and tolerate minor bumps
            PYO3_USE_ABI3_FORWARD_COMPATIBILITY: "1"
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Rust (stable)
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy, rustfmt

            - name: Setup Python
              id: python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Export PYO3_PYTHON
              run: echo "PYO3_PYTHON=${{ steps.python.outputs.python-path }}" >> $GITHUB_ENV

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: |
                      . -> target

            - name: Cargo fmt (check)
              run: cargo fmt --all -- --check

            - name: Build
              run: cargo build --verbose

            - name: Clippy
              run: cargo clippy --all-targets -- -D warnings

            - name: Test
              run: cargo test --all --verbose

            - name: Docs (ubuntu only)
              if: matrix.os == 'ubuntu-latest'
              run: cargo doc --no-deps

    fmt-fix:
        name: Auto fmt (PRs, same-repo only)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
        runs-on: ubuntu-latest
        permissions:
            contents: write
        defaults:
            run:
                working-directory: ai_runtime
                shell: bash
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Rust (stable)
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt

            - name: Run cargo fmt
              run: cargo fmt --all

            - name: Commit changes
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: "style(ai_runtime): apply cargo fmt"
                  file_pattern: "ai_runtime/**"
